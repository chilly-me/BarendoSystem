{% extends 'common/base.html' %}

{% load static %}
{% block title %}
    Complete your payment - MPESA
{% endblock %}

{% block content %}

{% include 'common/navigation.html' %}

<section style="height: 90vh; background-color: #F6FFF8;">
    <div class="col-12 col-md-8 col-lg-6 mx-auto p-4 text-center">
        <img src="{% static 'svg/M-PESA.png' %}" alt="" style="width: 125px; height: auto;" class="py-3">
        <h4>Complete Payment Using MPESA</h4>
        <hr>
        <h6>Total Amount to be debitted: <strong>Ksh. 4000</strong></h6>
        <br>
        <p>Paying with <strong>25471241341</strong>&nbsp;&nbsp;&nbsp;&nbsp;<a href="" style="text-decoration: none;">Change?</a></p>
        <br>
        <!--data-bs-toggle="modal" data-bs-target="#exampleModalCenter"-->
        <button id="pay-button" class="btn btn-outline-success" type="button" >
            Pay <img src="{% static 'svg/icons8-mpesa.svg' %}" alt="" style="height: 20px;">
        </button>
            
        {% if request_id %}
            <p>{{ request_id }}</p>
        {% endif %}
            
        <!-- Loading Modal -->
        <div class="modal fade" id="exampleModalCenter" data-bs-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content text-center">
                <div class="modal-header d-flex justify-content-center ">
                <h5 class="modal-title" id="exampleModalLongTitle">Status&nbsp;&nbsp;&nbsp;&nbsp;<img src="{% static 'svg/M-PESA.png' %}" alt="" style="height: 25px;"></h5>
                <!-- <button type="button" class="btn-close" aria-label="Close"></button> -->
        
                </div>
                <div class="modal-body">
                    <div class="spinner-border" style="color: #097302; " role="status">
                        <span class="sr-only"></span>
                      </div>
                    <p>Received Successfuly for processing, enter your PIN to authenticate</p>
                </div>
                <div class="modal-footer">
                <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div>
            </div>
        </div>
    </div>    
</section>

<script>
    $(document).ready(function () {
        $("#pay-button").click(function () {
            // Show the modal immediately
            $("#exampleModalCenter").modal("show");
            $(".modal-body").html(`
                <div class="spinner-border" style="color: #097302; " role="status">
                    <span class="sr-only"></span>
                </div>
                 
            `);

            // Send AJAX request to initiate payment
            $.ajax({
                url: "{% url 'payment:mpesa_payment' %}",  // Your Django view URL
                type: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}", // CSRF protection
                },
                success: function (response) {
                    if (response.request_id) {
                        console.log("In ");
                        // Update modal with request ID
                        $(".modal-body").html(`
                            <div class="spinner-border" style="color: #097302; " role="status">
                                <span class="sr-only"></span>
                            </div>
                            <p>Received Successfuly for processing, enter your PIN to authenticate</p>
                  
                        `);

                        let attempts = 0;
                        let maxAttempts = 30; // Stop checking after 30 attempts (~2.5 minutes)
                        
                        let interval = setInterval(function () {
                            if (attempts >= maxAttempts) {
                                clearInterval(interval);
                                $(".modal-body").html(`
                                    <p>Payment status check timed out. Please try again.</p>
                                `);
                                location.reload()
                                return;
                            }

                            // Send AJAX request to check payment status
                            $.ajax({
                                url: "{% url 'payment:check_payment_status' %}", // View to check payment status
                                type: "POST",
                                data: {
                                    csrfmiddlewaretoken: "{{ csrf_token }}",
                                    request_id: response.request_id
                                },
                                success: function (statusResponse) {
                                    const resultDesc = statusResponse.ResultDesc || "Payment failed. Please try again.";

                                    if (statusResponse.ResponseCode === "0") {
                                        console.log("In success block");
                                        clearInterval(timer);
                                        $(".modal-body").html(`
                                            <p>Processed Successfully</p>
                                            <p>${statusResponse.ResultDesc}</p>
                                        `);
                                    } else if (statusResponse.errorCode === "500.001.1001") {
                                        console.log("Payment is still being processed...");
                                    } else if (statusResponse.ResponseCode){
                                        console.log("In other block");

                                        clearInterval(timer);
                                        $(".modal-body").html(`
                                            <p>Processed unSuccessful</p>
                                            <p>${statusResponse.ResultDesc}</p>
                                        `);
                                    }
                                },
                                error: function () {
                                    $(".modal-body").html("<p>Error checking payment status. Please try again.</p>");
                                }
                            });

                            attempts++;
                        }, 2000); // Call API every 2 seconds

                    } else {
                        $(".modal-body").html("<p>Failed to initiate payment. Try again.</p>");
                    }
                },
                error: function () {
                    $(".modal-body").html("<p>Payment request failed. Please try again.</p>");
                }
            });
        });
    });
</script>


{% endblock %}